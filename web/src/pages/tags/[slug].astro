---
import BaseLayout from '@layouts/BaseLayout.astro';
import PostCard from '@components/PostCard.astro';
import { getPostsByTag, getTags } from '@lib/strapi';

export const prerender = import.meta.env.PROD;

export async function getStaticPaths() {
  if (!import.meta.env.PROD) {
    return [];
  }

  const tags = await getTags();

  if (!tags.length) {
    throw new Error('Strapi からタグ情報を取得できませんでした。公開タグが存在するか確認してください。');
  }

  return tags.map((tag) => ({ params: { slug: tag.slug } }));
}

const { slug } = Astro.params;
if (!slug) throw new Error('slug not provided');

const posts = await getPostsByTag(slug);
---
<BaseLayout title={`タグ: ${slug}`} description={`タグ「${slug}」の記事一覧`} canonical={Astro.url.href}>
  <section style="display: grid; gap: 1.5rem;">
    <header>
      <h1 style="margin: 0;">タグ: {slug}</h1>
      <p class="muted">該当する記事は {posts.length} 件です。</p>
    </header>
    <div class="grid posts">
      {posts.map((post) => (
        <PostCard post={post} />
      ))}
    </div>
  </section>
</BaseLayout>
