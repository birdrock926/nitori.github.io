---
import type { Post } from '@lib/strapi';
import { formatDateTime, relative, toMultilineHtml } from '@lib/format';

const { post } = Astro.props as { post: Post };

const cover = post.cover;
const coverAlt = cover?.alternativeText ?? cover?.caption ?? post.title ?? '';
const coverSources = cover?.formats ?? {};
const coverSrc =
  coverSources.medium?.url ?? coverSources.small?.url ?? coverSources.thumbnail?.url ?? cover?.url;
const coverSrcset = cover
  ? [
      coverSources.thumbnail?.url ? `${coverSources.thumbnail.url} 150w` : null,
      coverSources.small?.url ? `${coverSources.small.url} 320w` : null,
      coverSources.medium?.url ? `${coverSources.medium.url} 640w` : null,
      coverSources.large?.url ? `${coverSources.large.url} 960w` : null,
      cover?.url ? `${cover.url} ${cover.width ?? 1280}w` : null,
    ]
      .filter(Boolean)
      .join(', ')
  : undefined;
---
<article class="post-card card hover-lift">
  {coverSrc && (
    <a class="post-card-cover" href={`/posts/${post.slug}/`} aria-label={`${post.title} の詳細`}>
      <img
        src={coverSrc}
        srcset={coverSrcset}
        sizes="(max-width: 768px) 90vw, 280px"
        alt={coverAlt}
        loading="lazy"
        decoding="async"
      />
    </a>
  )}
  <header class="post-card-meta">
    <time dateTime={post.publishedAt} class="muted">
      {formatDateTime(post.publishedAt)}（{relative(post.publishedAt)}）
    </time>
    <div class="post-card-tags" role="list">
      {post.tags.map((tag) => (
        <a class="tag-chip" role="listitem" href={`/tags/${tag.slug}/`}>
          {tag.name}
        </a>
      ))}
    </div>
  </header>
  <h3 class="post-card-title"><a href={`/posts/${post.slug}/`}>{post.title}</a></h3>
  <p class="post-card-summary muted" set:html={toMultilineHtml(post.summary)}></p>
  <a class="post-card-link" href={`/posts/${post.slug}/`}>
    続きを読む<span aria-hidden="true">→</span>
  </a>
</article>

<style>
  .post-card {
    display: grid;
    gap: 0.85rem;
  }

  .post-card-cover {
    display: block;
    border-radius: 0.9rem;
    overflow: hidden;
    aspect-ratio: 16 / 9;
    max-height: 180px;
    background: var(--color-surface-subtle);
  }

  .post-card-cover img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  @media (min-width: 768px) {
    .post-card {
      grid-template-columns: 280px 1fr;
      align-items: center;
    }

    .post-card-cover {
      max-height: none;
    }
  }

  @media (max-width: 767px) {
    .post-card {
      grid-template-columns: 1fr;
    }
  }
</style>
